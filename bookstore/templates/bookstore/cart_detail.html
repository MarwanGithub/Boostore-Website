{% extends "bookstore/base.html" %}

{% block title %}
Your Shopping Cart
{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 dir="ltr">Your Shopping Cart</h1>
    
    <!-- Desktop Table View -->
    <div class="table-responsive d-none d-md-block">
        <table class="table table-striped" dir="ltr">
            <thead>
                <tr>
                    <th>Book</th>
                    <th>Remove</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart %}
                {% with book=item.book %}
                <tr data-book-row="{{ book.id }}">
                    <td>{{ book.title }}</td>
                    <td>
                        <button class="btn btn-link text-danger remove-btn" data-book-id="{{ book.id }}">
                            <span class="button-text">Remove</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </td>
                    <td class="num item-price" data-price-id="{{ book.id }}">EGP {{ item.price|floatformat:2 }}</td>
                </tr>
                {% endwith %}
                {% endfor %}
                <tr class="table-info">
                    <td colspan="2" class="text-end fw-bold">Total</td>
                    <td colspan="1" class="num fw-bold" id="cart-total-price">EGP {{ cart.get_total_price|floatformat:2 }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div class="d-md-none" dir="ltr">
        {% for item in cart %}
        {% with book=item.book %}
        <div class="card mb-3" data-book-row="{{ book.id }}">
            <div class="card-body">
                <h6 class="card-title">{{ book.title }}</h6>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <button class="btn btn-sm btn-outline-danger remove-btn" data-book-id="{{ book.id }}">
                        <span class="button-text">Remove</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <div class="text-end">
                        <small class="text-muted d-block">Price:</small>
                        <strong class="item-price" data-price-id="{{ book.id }}">EGP {{ item.price|floatformat:2 }}</strong>
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}
        
        <!-- Mobile Total -->
        <div class="card border-primary">
            <div class="card-body bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Total</h5>
                    <h5 class="mb-0" id="cart-total-price-mobile">EGP {{ cart.get_total_price|floatformat:2 }}</h5>
                </div>
            </div>
        </div>
    </div>
    <p class="text-end" dir="ltr">
        <a href="{% url 'bookstore:book_list' %}" class="btn btn-secondary">Continue shopping</a>
        <a href="{% url 'bookstore:contact_to_order' %}" class="btn btn-primary">Proceed to Order</a>
    </p>
</div>
{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const updateHeaderCart = (totalItems, cartTotalPrice) => {
        const headerCartCount = document.getElementById('header-cart-count');
        const floatingCartCount = document.getElementById('floating-cart-count');
        const headerCartTotal = document.getElementById('header-cart-total');

        if (headerCartCount) {
            headerCartCount.textContent = totalItems;
        }

        if (floatingCartCount) {
            floatingCartCount.textContent = totalItems;
        }

        if (headerCartTotal) {
            if (totalItems > 0) {
                const plural = totalItems > 1 ? 's' : '';
                headerCartTotal.innerHTML = `${totalItems} item${plural}, <span class='fw-bold'>EGP ${cartTotalPrice.toFixed(2)}</span>`;
            } else {
                headerCartTotal.textContent = 'Cart is empty';
            }
        }
    };



    const removeItem = (bookId) => {
        const removeButton = document.querySelector(`.remove-btn[data-book-id="${bookId}"]`);
        if(!removeButton) return;

        removeButton.disabled = true;
        removeButton.querySelector('.button-text').classList.add('d-none');
        removeButton.querySelector('.spinner-border').classList.remove('d-none');

        fetch(`/cart/remove/${bookId}/`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.removed) {
                // Handle both table row and card layouts
                const row = removeButton.closest('tr') || removeButton.closest('.card');
                if (row) row.remove();
                
                // Update both desktop and mobile cart totals
                const desktopTotal = document.getElementById('cart-total-price');
                const mobileTotal = document.getElementById('cart-total-price-mobile');
                if (desktopTotal) desktopTotal.textContent = `EGP ${data.cart_total_price.toFixed(2)}`;
                if (mobileTotal) mobileTotal.textContent = `EGP ${data.cart_total_price.toFixed(2)}`;
                
                updateHeaderCart(data.total_items, data.cart_total_price);
            }
        });
    };



    document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const bookId = button.dataset.bookId;
            removeItem(bookId);
        });
    });
});
</script>
{% endblock %} 